# Build stage
FROM golang:1.26.0@sha256:c83e68f3ebb6943a2904fa66348867d108119890a2c6a2e6f07b38d0eb6c25c5 AS builder

WORKDIR /go/src
COPY go.mod go.sum ./
RUN go mod download

COPY . .

ARG VERSION=dev
ARG COMMIT=""
ARG DATE=""

ENV CGO_ENABLED=0
RUN go build -cover \
    -ldflags="-s -w -X github.com/ctfer-io/chall-manager/cmd/chall-manager-janitor.Version=${VERSION} -X github.com/ctfer-io/chall-manager/cmd/chall-manager-janitor.Commit=${COMMIT} -X github.com/ctfer-io/chall-manager/cmd/chall-manager-janitor.Date=${DATE} -X github.com/ctfer-io/chall-manager/cmd/chall-manager-janitor.BuiltBy=docker" \
    -o /go/bin/chall-manager-janitor cmd/chall-manager-janitor/main.go



# Prod stage
FROM scratch
COPY --from=builder /go/bin/chall-manager-janitor /chall-manager-janitor
ENTRYPOINT [ "/chall-manager-janitor" ]
